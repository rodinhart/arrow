{"version":3,"sources":["io/stream.ts"],"names":[],"mappings":"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","file":"stream.js","sourcesContent":["// Licensed to the Apache Software Foundation (ASF) under one\r\n// or more contributor license agreements.  See the NOTICE file\r\n// distributed with this work for additional information\r\n// regarding copyright ownership.  The ASF licenses this file\r\n// to you under the Apache License, Version 2.0 (the\r\n// \"License\"); you may not use this file except in compliance\r\n// with the License.  You may obtain a copy of the License at\r\n//\r\n//   http://www.apache.org/licenses/LICENSE-2.0\r\n//\r\n// Unless required by applicable law or agreed to in writing,\r\n// software distributed under the License is distributed on an\r\n// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\n// KIND, either express or implied.  See the License for the\r\n// specific language governing permissions and limitations\r\n// under the License.\r\n\r\nimport streamAdapters from './adapters';\r\nimport { decodeUtf8 } from '../util/utf8';\r\nimport { ITERATOR_DONE, Readable, Writable, AsyncQueue } from './interfaces';\r\nimport { toUint8Array, joinUint8Arrays, ArrayBufferViewInput } from '../util/buffer';\r\n\r\nimport {\r\n    isPromise, isFetchResponse,\r\n    isIterable, isAsyncIterable,\r\n    isReadableDOMStream, isReadableNodeStream\r\n} from '../util/compat';\r\n\r\n/** @ignore */\r\nexport type WritableSink<T> = Writable<T> | WritableStream<T> | NodeJS.WritableStream | null;\r\n/** @ignore */\r\nexport type ReadableSource<T> = Readable<T> | PromiseLike<T> | AsyncIterable<T> | ReadableStream<T> | NodeJS.ReadableStream | null;\r\n\r\n/** @ignore */\r\nexport class AsyncByteQueue<T extends ArrayBufferViewInput = Uint8Array> extends AsyncQueue<Uint8Array, T> {\r\n    public write(value: ArrayBufferViewInput | Uint8Array) {\r\n        if ((value = toUint8Array(value)).byteLength > 0) {\r\n            return super.write(value as T);\r\n        }\r\n    }\r\n    public toString(sync: true): string;\r\n    public toString(sync?: false): Promise<string>;\r\n    public toString(sync = false) {\r\n        return sync\r\n            ? decodeUtf8(this.toUint8Array(true))\r\n            : this.toUint8Array(false).then(decodeUtf8);\r\n    }\r\n    public toUint8Array(sync: true): Uint8Array;\r\n    public toUint8Array(sync?: false): Promise<Uint8Array>;\r\n    public toUint8Array(sync = false) {\r\n        return sync ? joinUint8Arrays(this._values as any[])[0] : (async () => {\r\n            let buffers = [], byteLength = 0;\r\n            for await (const chunk of this) {\r\n                buffers.push(chunk);\r\n                byteLength += chunk.byteLength;\r\n            }\r\n            return joinUint8Arrays(buffers, byteLength)[0];\r\n        })();\r\n    }\r\n}\r\n\r\n/** @ignore */\r\nexport class ByteStream implements IterableIterator<Uint8Array> {\r\n    // @ts-ignore\r\n    private source: ByteStreamSource<Uint8Array>;\r\n    constructor(source?: Iterable<ArrayBufferViewInput> | ArrayBufferViewInput) {\r\n        if (source) {\r\n            this.source = new ByteStreamSource(streamAdapters.fromIterable(source));\r\n        }\r\n    }\r\n    [Symbol.iterator]() { return this; }\r\n    public next(value?: any) { return this.source.next(value); }\r\n    public throw(value?: any) { return this.source.throw(value); }\r\n    public return(value?: any) { return this.source.return(value); }\r\n    public peek(size?: number | null) { return this.source.peek(size); }\r\n    public read(size?: number | null) { return this.source.read(size); }\r\n}\r\n\r\n/** @ignore */\r\nexport class AsyncByteStream implements Readable<Uint8Array>, AsyncIterableIterator<Uint8Array> {\r\n    // @ts-ignore\r\n    private source: AsyncByteStreamSource<Uint8Array>;\r\n    constructor(source?: PromiseLike<ArrayBufferViewInput> | Response | ReadableStream<ArrayBufferViewInput> | NodeJS.ReadableStream | AsyncIterable<ArrayBufferViewInput> | Iterable<ArrayBufferViewInput>) {\r\n        if (source instanceof AsyncByteStream) {\r\n            this.source = (source as AsyncByteStream).source;\r\n        } else if (source instanceof AsyncByteQueue) {\r\n            this.source = new AsyncByteStreamSource(streamAdapters.fromAsyncIterable(source));\r\n        } else if (isReadableNodeStream(source)) {\r\n            this.source = new AsyncByteStreamSource(streamAdapters.fromNodeStream(source));\r\n        } else if (isReadableDOMStream<ArrayBufferViewInput>(source)) {\r\n            this.source = new AsyncByteStreamSource(streamAdapters.fromDOMStream(source));\r\n        } else if (isFetchResponse(source)) {\r\n            this.source = new AsyncByteStreamSource(streamAdapters.fromDOMStream(source.body!));\r\n        } else if (isIterable<ArrayBufferViewInput>(source)) {\r\n            this.source = new AsyncByteStreamSource(streamAdapters.fromIterable(source));\r\n        } else if (isPromise<ArrayBufferViewInput>(source)) {\r\n            this.source = new AsyncByteStreamSource(streamAdapters.fromAsyncIterable(source));\r\n        } else if (isAsyncIterable<ArrayBufferViewInput>(source)) {\r\n            this.source = new AsyncByteStreamSource(streamAdapters.fromAsyncIterable(source));\r\n        }\r\n    }\r\n    [Symbol.asyncIterator]() { return this; }\r\n    public next(value?: any) { return this.source.next(value); }\r\n    public throw(value?: any) { return this.source.throw(value); }\r\n    public return(value?: any) { return this.source.return(value); }\r\n    public get closed(): Promise<void> { return this.source.closed; }\r\n    public cancel(reason?: any) { return this.source.cancel(reason); }\r\n    public peek(size?: number | null) { return this.source.peek(size); }\r\n    public read(size?: number | null) { return this.source.read(size); }\r\n}\r\n\r\n/** @ignore */\r\ntype ByteStreamSourceIterator<T> = Generator<T, null, { cmd: 'peek' | 'read', size?: number | null }>;\r\n/** @ignore */\r\ntype AsyncByteStreamSourceIterator<T> = AsyncGenerator<T, null, { cmd: 'peek' | 'read', size?: number | null }>;\r\n\r\n/** @ignore */\r\nclass ByteStreamSource<T> {\r\n    constructor(protected source: ByteStreamSourceIterator<T>) {}\r\n    public cancel(reason?: any) { this.return(reason); }\r\n    public peek(size?: number | null): T | null { return this.next(size, 'peek').value; }\r\n    public read(size?: number | null): T | null { return this.next(size, 'read').value; }\r\n    public next(size?: number | null, cmd: 'peek' | 'read' = 'read') { return this.source.next({ cmd, size }); }\r\n    public throw(value?: any) { return Object.create((this.source.throw && this.source.throw(value)) || ITERATOR_DONE); }\r\n    public return(value?: any) { return Object.create((this.source.return && this.source.return(value)) || ITERATOR_DONE); }\r\n}\r\n\r\n/** @ignore */\r\nclass AsyncByteStreamSource<T> implements Readable<T> {\r\n\r\n    private _closedPromise: Promise<void>;\r\n    private _closedPromiseResolve?: (value?: any) => void;\r\n    constructor (protected source: ByteStreamSourceIterator<T> | AsyncByteStreamSourceIterator<T>) {\r\n        this._closedPromise = new Promise((r) => this._closedPromiseResolve = r);\r\n    }\r\n    public async cancel(reason?: any) { await this.return(reason); }\r\n    public get closed(): Promise<void> { return this._closedPromise; }\r\n    public async read(size?: number | null): Promise<T | null> { return (await this.next(size, 'read')).value; }\r\n    public async peek(size?: number | null): Promise<T | null> { return (await this.next(size, 'peek')).value; }\r\n    public async next(size?: number | null, cmd: 'peek' | 'read' = 'read') { return (await this.source.next({ cmd, size })); }\r\n    public async throw(value?: any) {\r\n        const result = (this.source.throw && await this.source.throw(value)) || ITERATOR_DONE;\r\n        this._closedPromiseResolve && this._closedPromiseResolve();\r\n        this._closedPromiseResolve = undefined;\r\n        return Object.create(result);\r\n    }\r\n    public async return(value?: any) {\r\n        const result = (this.source.return && await this.source.return(value)) || ITERATOR_DONE;\r\n        this._closedPromiseResolve && this._closedPromiseResolve();\r\n        this._closedPromiseResolve = undefined;\r\n        return Object.create(result);\r\n    }\r\n}\r\n"]}